plugins {
    id 'java'
    id 'application'
    id 'maven-publish'
    id 'org.jetbrains.kotlin.jvm' version '1.6.10'
    id 'io.papermc.paperweight.userdev' version '1.7.1'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
}

group = 'phonon.nodes'
version = '0.3'
def target = '1.20.4'
def jvmVersion = 21

repositories {
    mavenCentral()
    gradlePluginPortal()
    maven { url = 'https://repo.papermc.io/repository/maven-public/' }
    maven { url = 'https://repo.dmulloy2.net/nexus/repository/public/' }
    maven { url = 'https://repo.extendedclip.com/releases/' }
    maven { url = 'https://repo.repsy.io/mvn/tlm920/minecraft' }
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(jvmVersion)
    }
}

dependencies {
    // Kotlin
    implementation platform('org.jetbrains.kotlin:kotlin-bom')
    implementation 'org.jetbrains.kotlin:kotlin-stdlib-jdk8'

    // JSON y utilidades
    implementation 'com.google.code.gson:gson:2.8.9'
    compileOnly 'com.comphenix.protocol:ProtocolLib:5.3.0'
    compileOnly 'me.clip:placeholderapi:2.11.6'

    // Tests
    testImplementation 'org.jetbrains.kotlin:kotlin-test'
    testImplementation 'org.jetbrains.kotlin:kotlin-test-junit'

    // Paper API
    compileOnly "io.papermc.paper:paper-api:${target}-R0.1-SNAPSHOT"

    // Paper dev bundle
    paperweightDevBundle "io.papermc.paper:dev-bundle:1.20.1-R0.1-SNAPSHOT"
}

application {
    mainClass = 'phonon.nodes.NodesPluginKt'
}

tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile) {
    kotlinOptions {
        jvmTarget = '21'
    }
}

tasks.processResources {
    inputs.property 'version', project.version
    filesMatching('plugin.yml') {
        expand(version: project.version)
    }
}

tasks.build {
    dependsOn tasks.shadowJar
}

tasks.named('shadowJar') {
    relocate 'com.google', 'nodes.shadow.gson'
    if (project.hasProperty('prod')) {
        archiveBaseName.set("${project.name}-${target}-${version}")
        minimize()
    } else {
        archiveFileName.set("${project.name}-${target}-${version}-DEV.jar")
    }
}
